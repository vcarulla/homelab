---
services:
  traefik:
    container_name: traefik
    image: traefik:v3.6.6
    read_only: true
    security_opt:
      - no-new-privileges:true
    cap_drop:
      - ALL
    cap_add:
      - NET_BIND_SERVICE  # Para puertos 80/443
    tmpfs:
      - /tmp:rw,noexec,nosuid,size=100m
    deploy:
      resources:
        limits:
          cpus: '1.0'
          memory: 512M
        reservations:
          cpus: '0.2'
          memory: 128M   
    env_file:
      - ../.env
    environment:
      - TZ=${TZ}
    ports:
      - 80:80
      - 443:443
    volumes:
      - ./config/:/etc/traefik/:ro
      - traefik_logs:/var/log/traefik:rw
      - vault_secrets_tmpfs:/vault/secrets:ro  # Certificados y config desde Vault Agent
    networks:
      - frontend
      - backend
    healthcheck:
      test: ["CMD", "traefik", "healthcheck", "--ping"]
      interval: 30s
      timeout: 3s
      retries: 3
      start_period: 40s
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
        labels: "service={{.Name}},component=reverse-proxy,environment=homelab"
    labels:
      - "traefik.enable=true"
      # HTTPS router
      - "traefik.http.routers.dashboard.entrypoints=websecure"
      - "traefik.http.routers.dashboard.rule=Host(`traefik.${DOMAIN_ICARUS}`) && (PathPrefix(`/api`) || PathPrefix(`/dashboard`))"
      - "traefik.http.routers.dashboard.tls=true"
      - "traefik.http.routers.dashboard.middlewares=internal-access@file,auth-basic@file"
      - "traefik.http.routers.dashboard.service=api@internal"
    restart: unless-stopped

volumes:
  traefik_logs:
    driver: local
  vault_secrets_tmpfs:
    external: true
    name: shared-vault-agent_vault_secrets_tmpfs

networks:
  frontend:
    external: true
  backend:
    external: true
